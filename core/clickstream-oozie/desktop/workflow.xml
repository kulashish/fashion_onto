<workflow-app xmlns='uri:oozie:workflow:0.3' name='desktop-clickstream-wf'>
	<start to='prepare_variables' />
	<action name='prepare_variables'>
		<shell xmlns="uri:oozie:shell-action:0.1">
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queueName}</value>
				</property>
			</configuration>
			<exec>${prepareVariablesPath}</exec>
			<argument>${HdfsInputPath}</argument>
			<argument>${HiveOutput}</argument>
			<file>${prepareVariablesPath}</file>
			<capture-output/>
		</shell>
		<ok to='bson_to_text' />
		<error to='mail_on_error' />
	</action>
	<action name='bson_to_text'>
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queueName}</value>
				</property>
			</configuration>
			<main-class>${bsonToTextMainClass}</main-class>
			<arg>${wf:actionData('prepare_variables')['HdfsBsonData']}</arg>
			<arg>${wf:actionData('prepare_variables')['HdfsInputPath']}/mr</arg>
			<file>${bsonToTextJarPath}</file>
		</java>
		<ok to='mkdir_OUTPUT' />
		<error to='mail_on_error' />
	</action>
	<action name='mkdir_OUTPUT'>
		<fs>
			<mkdir path="${wf:actionData('prepare_variables')['DailyHiveOutput']}/reports" />
			<mkdir path="${PagevisitDir}/${wf:actionData('prepare_variables')['LAST_YEAR']}/${wf:actionData('prepare_variables')['LAST_MONTH']}/${wf:actionData('prepare_variables')['LAST_DAY']}" />
		</fs>
		<ok to='create_pagevisit_000_setup_emr' />
		<error to='step_failure' />
	</action>
	<action name='create_pagevisit_000_setup_emr'>
		<hive xmlns="uri:oozie:hive-action:0.2">
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<configuration>
				<property>
					<name>mapred.compress.map.output</name>
					<value>true</value>
				</property>
				<property>
					<name>hive.execution.engine</name>
					<value>tez</value>
				</property>
				<property>
					<name>hive.metastore.client.connect.retry.delay</name>
					<value>5</value>
				</property>
				<property>
					<name>hive.metastore.client.socket.timeout</name>
					<value>1800</value>
				</property>
			</configuration>
			<script>${setupEmrScript}</script>
			<param>hivedb=${hivedb}</param>
		</hive>
		<ok to='create_pagevisit_001_create_master_tables' />
		<error to='mail_on_error' />
	</action>
	<action name='create_pagevisit_001_create_master_tables'>
		<hive xmlns="uri:oozie:hive-action:0.2">
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<configuration>
				<property>
					<name>mapred.compress.map.output</name>
					<value>true</value>
				</property>
				<property>
					<name>hive.execution.engine</name>
					<value>tez</value>
				</property>
				<property>
					<name>hive.metastore.client.connect.retry.delay</name>
					<value>5</value>
				</property>
				<property>
					<name>hive.metastore.client.socket.timeout</name>
					<value>1800</value>
				</property>
			</configuration>
			<script>${createMasterTablesScript}</script>
			<param>hivedb=${hivedb}</param>
			<param>INPUT=${wf:actionData('prepare_variables')['HdfsInputPath']}/mr</param>
		</hive>
		<ok to='create_pagevisit_001_create_sku_cat_table' />
		<error to='mail_on_error' />
	</action>
	<action name='create_pagevisit_001_create_sku_cat_table'>
		<hive xmlns="uri:oozie:hive-action:0.2">
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<configuration>
				<property>
					<name>mapred.compress.map.output</name>
					<value>true</value>
				</property>
				<property>
					<name>hive.execution.engine</name>
					<value>tez</value>
				</property>
				<property>
					<name>hive.metastore.client.connect.retry.delay</name>
					<value>5</value>
				</property>
				<property>
					<name>hive.metastore.client.socket.timeout</name>
					<value>1800</value>
				</property>
			</configuration>
			<script>${createSkuCatTablesScript}</script>
			<param>hivedb=${hivedb}</param>
			<param>S3_DAILY_INPUT=${wf:actionData('prepare_variables')['HdfsBsonData']}</param>
			<file>${reportsCoreHiveUdfJarPath}</file>
		</hive>
		<ok to='create_pagevisit_002_create_pagevisit_table' />
		<error to='mail_on_error' />
	</action>
	<action name='create_pagevisit_002_create_pagevisit_table'>
		<hive xmlns="uri:oozie:hive-action:0.2">
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<configuration>
				<property>
					<name>mapred.compress.map.output</name>
					<value>true</value>
				</property>
				<property>
					<name>hive.execution.engine</name>
					<value>tez</value>
				</property>
				<property>
					<name>hive.metastore.client.connect.retry.delay</name>
					<value>5</value>
				</property>
				<property>
					<name>hive.metastore.client.socket.timeout</name>
					<value>1800</value>
				</property>
			</configuration>
			<script>${createPagevisitTableScript}</script>
			<param>hivedb=${hivedb}</param>
			<param>PagevisitDir=${PagevisitDir}/${wf:actionData('prepare_variables')['LAST_YEAR']}/${wf:actionData('prepare_variables')['LAST_MONTH']}/${wf:actionData('prepare_variables')['LAST_DAY']}</param>
			<file>${reportsCoreHiveUdfJarPath}</file>
		</hive>
		<ok to='create_dailyPagevisit_Partition' />
		<error to='mail_on_error' />
	</action>
	<action name='create_dailyPagevisit_Partition'>
		<hive xmlns="uri:oozie:hive-action:0.2">
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<configuration>
				<property>
					<name>mapred.compress.map.output</name>
					<value>true</value>
				</property>
				<property>
					<name>hive.execution.engine</name>
					<value>tez</value>
				</property>
				<property>
					<name>hive.metastore.client.connect.retry.delay</name>
					<value>5</value>
				</property>
				<property>
					<name>hive.metastore.client.socket.timeout</name>
					<value>1800</value>
				</property>
			</configuration>
			<script>${createDailyPagevisitPartitionScript}</script>
			<param>dbname=${partitionedDb}</param>
			<param>tableName=${partionTable}</param>
			<param>year1=${wf:actionData('prepare_variables')['LAST_YEAR']}</param>
			<param>month1=${wf:actionData('prepare_variables')['LAST_MONTH']}</param>
			<param>date1=${wf:actionData('prepare_variables')['LAST_DAY']}</param>
			<param>loc=${PagevisitDir}/${wf:actionData('prepare_variables')['LAST_YEAR']}/${wf:actionData('prepare_variables')['LAST_MONTH']}/${wf:actionData('prepare_variables')['LAST_DAY']}</param>
		</hive>
		<ok to='end' />
		<error to='mail_on_error' />
	</action>
	<action name='hive_daily_reports'>
		<hive xmlns="uri:oozie:hive-action:0.2">
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<configuration>
				<property>
					<name>mapred.compress.map.output</name>
					<value>true</value>
				</property>
				<property>
					<name>hive.execution.engine</name>
					<value>tez</value>
				</property>
				<property>
					<name>hive.metastore.client.connect.retry.delay</name>
					<value>5</value>
				</property>
				<property>
					<name>hive.metastore.client.socket.timeout</name>
					<value>1800</value>
				</property>
				<property>
					<name>hive.exec.reducers.bytes.per.reducer</name>
					<value>1000000000</value>
				</property>
			</configuration>
			<script>${hiveDailyReportsScript}</script>
			<param>hivedb=${hivedb}</param>
			<param>OUTPUT=${wf:actionData('prepare_variables')['DailyHiveOutput']}</param>
			<param>-hivevar</param>
			<param>FieldSeparator=${fieldSeparator}</param>
			<param>-hivevar</param>
			<param>CollectionSeparator=${collectionSeparator}</param>
		</hive>
		<ok to='clean_dir' />
		<error to='mail_on_error' />
	</action>
	<action name='clean_dir'>
		<fs>
			<delete path="${wf:actionData('prepare_variables')['HdfsInputPath']}" />
		</fs>
		<ok to='mail_on_success' />
		<error to='mail_on_error' />
	</action>
	<action name='mail_on_error'>
		<email xmlns="uri:oozie:email-action:0.2">
			<to>${mailRecepients}</to>
			<subject>${env} Workflow for old desktop for ${wf:actionData('prepare_variables')['DATER']} failed.</subject>
			<body>Node: [${wf:lastErrorNode()}] \n Error: [${wf:errorMessage(wf:lastErrorNode())}]</body>
		</email>
		<ok to='step_failure' />
		<error to='step_failure' />
	</action>
	<action name='mail_on_success'>
		<email xmlns="uri:oozie:email-action:0.2">
			<to>${mailRecepients}</to>
			<subject> ${env} Workflow for old desktop for ${wf:actionData('prepare_variables')['DATER']} was successful.</subject>
			<body></body>
		</email>
		<ok to='end' />
		<error to='end' />
	</action>
	<kill name='step_failure'>
		<message>Script failed, error message[${wf:errorMessage(wf:lastErrorNode())}]</message>
	</kill>
	<end name='end' />
</workflow-app>










